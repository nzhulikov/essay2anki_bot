name: essay2anki-bot-setup
description: Sets up the environment for the Essay2Anki Telegram bot
schemaVersion: 1.0
phases:
  - name: build
    steps:
      - name: InstallSystemDependencies
        action: ExecuteBash
        inputs:
          commands:
            - apt-get update
            - apt-get install -y python3 python3-pip python3-venv git
            - apt-get clean
            - rm -rf /var/lib/apt/lists/*

      - name: CreateBotDirectory
        action: ExecuteBash
        inputs:
          commands:
            - mkdir -p /opt/essay2anki_bot
            - cd /opt/essay2anki_bot

      - name: CloneBotRepository
        action: ExecuteBash
        inputs:
          commands:
            - git clone https://github.com/nzhulikov/essay2anki_bot.git .

      - name: SetupPythonEnvironment
        action: ExecuteBash
        inputs:
          commands:
            - python3 -m venv venv
            - source venv/bin/activate
            - pip install --upgrade pip
            - pip install -r requirements.txt

      - name: CreateSystemdService
        action: ExecuteBash
        inputs:
          commands:
            - cat > /etc/systemd/system/essay2anki-bot.service << 'EOL'
            - [Unit]
            - Description=Essay2Anki Telegram Bot
            - After=network.target
            - 
            - [Service]
            - Type=simple
            - User=root
            - WorkingDirectory=/opt/essay2anki_bot
            - Environment=ESSAY2ANKI_BOT_KEY=${ESSAY2ANKI_BOT_KEY}
            - Environment=ESSAY2ANKI_OPENAI_KEY=${ESSAY2ANKI_OPENAI_KEY}
            - ExecStart=/opt/essay2anki_bot/venv/bin/python __main__.py
            - Restart=always
            - RestartSec=10
            - 
            - [Install]
            - WantedBy=multi-user.target
            - EOL

      - name: SetPermissions
        action: ExecuteBash
        inputs:
          commands:
            - chmod 644 /etc/systemd/system/essay2anki-bot.service
            - systemctl daemon-reload
            - systemctl enable essay2anki-bot.service

      - name: CreateLogDirectory
        action: ExecuteBash
        inputs:
          commands:
            - mkdir -p /var/log/essay2anki_bot
            - chmod 755 /var/log/essay2anki_bot

tests:
  - name: TestBotService
    action: ExecuteBash
    inputs:
      commands:
        - systemctl is-active essay2anki-bot.service || exit 1
        - systemctl is-enabled essay2anki-bot.service || exit 1 